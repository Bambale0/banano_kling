–Ω—É–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å UX –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å https://github.com/Bambale0/banano_kling   , —É–±—Ä–∞—Ç—å –ø—Ä–µ—Å–µ—Ç—ã –∏ –ø—Ä–∏–≤—è–∑–∫—É –∫ –Ω–∏–º. —Å–æ–∑–¥–∞—Ç—å –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –∫–æ—Ç–æ—Ä–æ–º —é–∑–µ—Ä –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –º–æ–¥–µ–ª—å –∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ –±—ã –æ–¥–∏–Ω —Ä–∞–∑ –≤—ã–±—Ä–∞–ª –º–æ–¥–µ–ª—å –∏ —ç—Ç–∞ –º–æ–¥–µ–ª—å –±—ã–ª–∞ –Ω–∞ –ø–æ—Å—Ç–æ–Ω–Ω–∫–µ, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–µ–Ω–∏—Ç. –≤—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ. —É–±—Ä–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π. –°–¥–µ–ª–∞—Ç—å —Ç–∞–∫ —á—Ç–æ –±—ã "–±–ª–æ–Ω–¥–∏–Ω–∫–∞" –ø–æ–Ω—è–ª–∞ –∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–∞–ª–µ–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∞—Å–ø–µ–∫—Ç —Ä–∞—Ç–∏–æ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Å–∏—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ> –¥–∞–ª–µ–µ –ø—Ä–æ–º–ø—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è > –∞—Å–ø–µ–∫—Ç —Ä–∞—Ç–∏–æ > –ø–æ–ª—É—á–∏—Ç—å –Ω—É–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
Edit
Copy
Share
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –∫–æ–¥–æ–≤—É—é –±–∞–∑—É. –ü–æ–Ω—è–ª –∑–∞–¥–∞—á—É: –Ω—É–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å UX, —É–±—Ä–∞—Ç—å –ø—Ä–µ—Å–µ—Ç—ã, —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏, —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, —Å–¥–µ–ª–∞—Ç—å –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å "–¥–ª—è –±–ª–æ–Ω–¥–∏–Ω–∫–∏".
–í–æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–≥–æ –±–æ—Ç–∞:
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
plain
Copy
bot/
‚îú‚îÄ‚îÄ config.py                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ start.py                 # –°—Ç–∞—Ä—Ç –∏ –º–µ–Ω—é
‚îÇ   ‚îú‚îÄ‚îÄ settings.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏/–∫–∞—á–µ—Å—Ç–≤–∞
‚îÇ   ‚îú‚îÄ‚îÄ image_generation.py      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)
‚îÇ   ‚îú‚îÄ‚îÄ image_editing.py         # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ video_generation.py      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ gemini_service.py        # –¢–≤–æ–π —Ç–µ–∫—É—â–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ kling_service.py         # –¢–≤–æ–π —Ç–µ–∫—É—â–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îÇ   ‚îî‚îÄ‚îÄ user_settings.py         # –ù–û–í–û–ï: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ states.py                    # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îî‚îÄ‚îÄ keyboards.py                 # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
1. –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (services/user_settings.py)
Python
Copy
import json
import logging
from pathlib import Path
from typing import Optional, Dict, Any
from dataclasses import dataclass, asdict

logger = logging.getLogger(__name__)

@dataclass
class UserSettings:
    user_id: int
    image_model: str = "flash"  # flash –∏–ª–∏ pro
    video_quality: str = "std"  # std –∏–ª–∏ pro
    default_aspect_ratio: str = "1:1"
    
    def to_dict(self) -> Dict[str, Any]:
        return asdict(self)
    
    @classmethod
    def from_dict(cls, data: Dict) -> "UserSettings":
        return cls(**data)


class UserSettingsManager:
    """–ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ JSON"""
    
    def __init__(self, storage_path: str = "data/user_settings.json"):
        self.storage_path = Path(storage_path)
        self.storage_path.parent.mkdir(parents=True, exist_ok=True)
        self._cache: Dict[int, UserSettings] = {}
        self._load_all()
    
    def _load_all(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        if self.storage_path.exists():
            try:
                with open(self.storage_path, "r", encoding="utf-8") as f:
                    data = json.load(f)
                    for user_id, settings_data in data.items():
                        self._cache[int(user_id)] = UserSettings.from_dict(settings_data)
            except Exception as e:
                logger.error(f"Failed to load settings: {e}")
    
    def _save_all(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        try:
            data = {str(uid): s.to_dict() for uid, s in self._cache.items()}
            with open(self.storage_path, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"Failed to save settings: {e}")
    
    def get_settings(self, user_id: int) -> UserSettings:
        """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ–∑–¥–∞—ë—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –µ—Å–ª–∏ –Ω–µ—Ç)"""
        if user_id not in self._cache:
            self._cache[user_id] = UserSettings(user_id=user_id)
            self._save_all()
        return self._cache[user_id]
    
    def update_settings(self, user_id: int, **kwargs):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        settings = self.get_settings(user_id)
        for key, value in kwargs.items():
            if hasattr(settings, key):
                setattr(settings, key, value)
        self._save_all()
    
    def get_image_model(self, user_id: int) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
        return self.get_settings(user_id).image_model
    
    def get_video_quality(self, user_id: int) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ"""
        return self.get_settings(user_id).video_quality

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
settings_manager = UserSettingsManager()
2. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (keyboards.py)
Python
Copy
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–ø—Ä–æ—Å—Ç–æ–µ)
def main_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")],
            [KeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")],
            [KeyboardButton(text="üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ],
        resize_keyboard=True
    )

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
def settings_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª—å –ò–ò", callback_data="setting_model")],
        [InlineKeyboardButton(text="üìπ –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ", callback_data="setting_video")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")],
    ])

# –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
def model_selection(current_model: str):
    flash_check = "‚úÖ " if current_model == "flash" else ""
    pro_check = "‚úÖ " if current_model == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{flash_check}‚ö° Flash (–±—ã—Å—Ç—Ä–æ)", callback_data="set_model_flash")],
        [InlineKeyboardButton(text=f"{pro_check}üé® Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_model_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –í—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
def video_quality_selection(current_quality: str):
    std_check = "‚úÖ " if current_quality == "std" else ""
    pro_check = "‚úÖ " if current_quality == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{std_check}‚ö° Standard (–±—ã—Å—Ç—Ä–æ)", callback_data="set_video_std")],
        [InlineKeyboardButton(text=f"{pro_check}üé¨ Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_video_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
def aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="1:1", callback_data="aspect_1:1"),
            InlineKeyboardButton(text="16:9", callback_data="aspect_16:9"),
            InlineKeyboardButton(text="9:16", callback_data="aspect_9:16"),
        ],
        [
            InlineKeyboardButton(text="4:3", callback_data="aspect_4:3"),
            InlineKeyboardButton(text="3:4", callback_data="aspect_3:4"),
            InlineKeyboardButton(text="2:3", callback_data="aspect_2:3"),
        ],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –≤–∏–¥–µ–æ
def video_aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="16:9 (—à–∏—Ä–æ–∫–∏–π)", callback_data="video_aspect_16:9"),
            InlineKeyboardButton(text="9:16 (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π)", callback_data="video_aspect_9:16"),
        ],
        [InlineKeyboardButton(text="1:1 (–∫–≤–∞–¥—Ä–∞—Ç)", callback_data="video_aspect_1:1")],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ
def video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="duration_5"),
            InlineKeyboardButton(text="7 —Å–µ–∫", callback_data="duration_7"),
        ],
        [
            InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="duration_10"),
            InlineKeyboardButton(text="12 —Å–µ–∫", callback_data="duration_12"),
            InlineKeyboardButton(text="15 —Å–µ–∫", callback_data="duration_15"),
        ],
    ])
3. –°–æ—Å—Ç–æ—è–Ω–∏—è (states.py)
Python
Copy
from aiogram.fsm.state import State, StatesGroup

class ImageGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class ImageEditState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class VideoGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_image_or_skip = State()  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è I2V
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()
4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (handlers/image_generation.py)
Python
Copy
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext

from bot.services.gemini_service import gemini_service
from bot.services.user_settings import settings_manager
from bot.keyboards import aspect_ratio_keyboard, main_menu
from bot.states import ImageGenState

router = Router()
logger = logging.getLogger(__name__)

@router.message(F.text == "üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
async def start_image_generation(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - —Å—Ä–∞–∑—É –ø—Ä–æ—Å–∏–º –ø—Ä–æ–º–ø—Ç"""
    model = settings_manager.get_image_model(message.from_user.id)
    model_name = "‚ö° Flash" if model == "flash" else "üé® Pro"
    
    await message.answer(
        f"üé® <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b>\n"
        f"–ú–æ–¥–µ–ª—å: {model_name}\n\n"
        f"‚úèÔ∏è <b>–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</b>\n"
        f"–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ö—Ä–∞—Å–Ω—ã–π –∫–æ—Ç –≤ –∫–æ—Å–º–æ—Å–µ¬ª",
        parse_mode="HTML"
    )
    await state.set_state(ImageGenState.waiting_for_prompt)

@router.message(ImageGenState.waiting_for_prompt)
async def receive_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç - —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ: <i>{prompt}</i>\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</b>",
        parse_mode="HTML",
        reply_markup=aspect_ratio_keyboard()
    )
    await state.set_state(ImageGenState.waiting_for_aspect_ratio)

@router.callback_query(ImageGenState.waiting_for_aspect_ratio, F.data.startswith("aspect_"))
async def receive_aspect_ratio(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ –∞—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ - —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º"""
    aspect_ratio = callback.data.replace("aspect_", "")
    data = await state.get_data()
    prompt = data["prompt"]
    user_id = callback.from_user.id
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å
    model_pref = settings_manager.get_image_model(user_id)
    model = "gemini-2.5-flash-image" if model_pref == "flash" else "gemini-3-pro-image-preview"
    
    await callback.message.edit_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
    await state.set_state(ImageGenState.generating)
    
    try:
        result = await gemini_service.generate_image(
            prompt=prompt,
            model=model,
            aspect_ratio=aspect_ratio
        )
        
        if result:
            await callback.message.delete()
            await bot.send_photo(
                chat_id=user_id,
                photo=result,
                caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio}",
                reply_markup=main_menu()
            )
        else:
            await callback.message.edit_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"Image generation failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=main_menu()
        )
    
    await state.clear()

@router.callback_query(ImageGenState.waiting_for_aspect_ratio, F.data == "cancel")
async def cancel_generation(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞"""
    await callback.message.edit_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ")
    await callback.message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu())
    await state.clear()
5. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (handlers/image_editing.py)
Python
Copy
import logging
import io
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, PhotoSize
from aiogram.fsm.context import FSMContext

from bot.services.gemini_service import gemini_service
from bot.services.user_settings import settings_manager
from bot.keyboards import aspect_ratio_keyboard, main_menu
from bot.states import ImageEditState

router = Router()
logger = logging.getLogger(__name__)

@router.message(F.text == "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
async def start_image_editing(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø—Ä–æ—Å–∏–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
    await message.answer(
        "‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b>\n\n"
        "üìé <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b> (—Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª)\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG",
        parse_mode="HTML"
    )
    await state.set_state(ImageEditState.waiting_for_image)

@router.message(ImageEditState.waiting_for_image, F.photo)
async def receive_photo(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    # –ë–µ—Ä—ë–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    photo = message.photo[-1]
    await process_image(message, photo.file_id, state)

@router.message(ImageEditState.waiting_for_image, F.document)
async def receive_document(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG –∏–ª–∏ PNG)")
        return
    await process_image(message, doc.file_id, state)

async def process_image(message: Message, file_id: str, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
    
    try:
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await message.bot.get_file(file_id)
        image_bytes = await message.bot.download_file(file.file_path)
        image_data = image_bytes.read()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.update_data(image=image_data)
        
        await message.answer(
            "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n\n"
            "‚úèÔ∏è <b>–ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å?</b>\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
            "‚Ä¢ ¬´–°–¥–µ–ª–∞–π —Ñ–æ–Ω —Å–∏–Ω–∏–º¬ª\n"
            "‚Ä¢ ¬´–î–æ–±–∞–≤—å —Å–æ–ª–Ω–µ—á–Ω—ã–µ –æ—á–∫–∏¬ª\n"
            "‚Ä¢ ¬´–ü—Ä–µ–≤—Ä–∞—Ç–∏ –≤ –º—É–ª—å—Ç—Ñ–∏–ª—å–º¬ª",
            parse_mode="HTML"
        )
        await state.set_state(ImageEditState.waiting_for_prompt)
        
    except Exception as e:
        logger.exception(f"Failed to process image: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ.")

@router.message(ImageEditState.waiting_for_prompt)
async def receive_edit_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ –ó–∞–¥–∞—á–∞: <i>{prompt}</i>\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:</b>",
        parse_mode="HTML",
        reply_markup=aspect_ratio_keyboard()
    )
    await state.set_state(ImageEditState.waiting_for_aspect_ratio)

@router.callback_query(ImageEditState.waiting_for_aspect_ratio, F.data.startswith("aspect_"))
async def execute_edit(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    aspect_ratio = callback.data.replace("aspect_", "")
    data = await state.get_data()
    prompt = data["prompt"]
    image_data = data["image"]
    user_id = callback.from_user.id
    
    model_pref = settings_manager.get_image_model(user_id)
    model = "gemini-2.5-flash-image" if model_pref == "flash" else "gemini-3-pro-image-preview"
    
    await callback.message.edit_text("‚è≥ –†–µ–¥–∞–∫—Ç–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
    await state.set_state(ImageEditState.generating)
    
    try:
        result = await gemini_service.edit_image(
            image_bytes=image_data,
            instruction=prompt,
            model=model,
            aspect_ratio=aspect_ratio
        )
        
        if result:
            await callback.message.delete()
            await bot.send_photo(
                chat_id=user_id,
                photo=result,
                caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio}",
                reply_markup=main_menu()
            )
        else:
            await callback.message.edit_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"Image editing failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=main_menu()
        )
    
    await state.clear()
6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ (handlers/video_generation.py)
Python
Copy
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext

from bot.services.kling_service import kling_service
from bot.services.user_settings import settings_manager
from bot.keyboards import video_aspect_ratio_keyboard, video_duration_keyboard, main_menu
from bot.states import VideoGenState

router = Router()
logger = logging.getLogger(__name__)

@router.message(F.text == "üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ")
async def start_video_generation(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ"""
    quality = settings_manager.get_video_quality(message.from_user.id)
    quality_name = "‚ö° Standard" if quality == "std" else "üé¨ Pro"
    
    await message.answer(
        f"üé¨ <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ</b>\n"
        f"–ö–∞—á–µ—Å—Ç–≤–æ: {quality_name}\n\n"
        f"‚úèÔ∏è <b>–û–ø–∏—à–∏—Ç–µ –≤–∏–¥–µ–æ:</b>\n"
        f"–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ö–æ—Ç —Ç–∞–Ω—Ü—É–µ—Ç –ø–æ–¥ –¥–æ–∂–¥—ë–º¬ª",
        parse_mode="HTML"
    )
    await state.set_state(VideoGenState.waiting_for_prompt)

@router.message(VideoGenState.waiting_for_prompt)
async def receive_video_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ {prompt}\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(VideoGenState.waiting_for_aspect_ratio)

@router.callback_query(VideoGenState.waiting_for_aspect_ratio, F.data.startswith("video_aspect_"))
async def receive_video_aspect(callback: CallbackQuery, state: FSMContext):
    aspect_ratio = callback.data.replace("video_aspect_", "")
    await state.update_data(aspect_ratio=aspect_ratio)
    
    await callback.message.edit_text(
        f"üìê {aspect_ratio}\n\n"
        f"‚è± <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b>",
        parse_mode="HTML",
        reply_markup=video_duration_keyboard()
    )
    await state.set_state(VideoGenState.waiting_for_duration)

@router.callback_query(VideoGenState.waiting_for_duration, F.data.startswith("duration_"))
async def generate_video(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤–∏–¥–µ–æ"""
    duration = int(callback.data.replace("duration_", ""))
    data = await state.get_data()
    prompt = data["prompt"]
    aspect_ratio = data["aspect_ratio"]
    user_id = callback.from_user.id
    
    quality = settings_manager.get_video_quality(user_id)
    
    await callback.message.edit_text(
        f"‚è≥ –°–æ–∑–¥–∞—é –≤–∏–¥–µ–æ...\n"
        f"–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-5 –º–∏–Ω—É—Ç"
    )
    await state.set_state(VideoGenState.generating)
    
    try:
        # –í—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞
        if quality == "pro":
            result = await kling_service.generate_video_pro(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio
            )
        else:
            result = await kling_service.generate_video_std(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio
            )
        
        if result and result.get("task_id"):
            task_id = result["task_id"]
            
            # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
            status = await kling_service.wait_for_completion(task_id, max_attempts=60, delay=5)
            
            if status and status.get("data", {}).get("status") == "COMPLETED":
                video_url = status["data"]["result"]["video_url"]
                
                await callback.message.delete()
                await bot.send_video(
                    chat_id=user_id,
                    video=video_url,
                    caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio} | ‚è± {duration}—Å–µ–∫",
                    reply_markup=main_menu()
                )
            else:
                await callback.message.edit_text(
                    "‚ùå –í–∏–¥–µ–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.",
                    reply_markup=main_menu()
                )
        else:
            await callback.message.edit_text(
                "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"Video generation failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ.",
            reply_markup=main_menu()
        )
    
    await state.clear()
7. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (handlers/settings.py)
Python
Copy
from aiogram import Router, F
from aiogram.types import CallbackQuery, Message
from bot.services.user_settings import settings_manager
from bot.keyboards import settings_menu, model_selection, video_quality_selection, main_menu

router = Router()

@router.message(F.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
async def show_settings(message: Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
    settings = settings_manager.get_settings(message.from_user.id)
    
    model_name = "‚ö° Flash" if settings.image_model == "flash" else "üé® Pro"
    video_name = "‚ö° Standard" if settings.video_quality == "std" else "üé¨ Pro"
    
    await message.answer(
        f"‚öôÔ∏è <b>–í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
        f"ü§ñ <b>–ú–æ–¥–µ–ª—å –ò–ò:</b> {model_name}\n"
        f"   –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n\n"
        f"üìπ <b>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ:</b> {video_name}\n"
        f"   –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ\n\n"
        f"<i>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å:</i>",
        parse_mode="HTML",
        reply_markup=settings_menu()
    )

@router.callback_query(F.data == "settings")
async def back_to_settings(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
    settings = settings_manager.get_settings(callback.from_user.id)
    
    model_name = "‚ö° Flash" if settings.image_model == "flash" else "üé® Pro"
    video_name = "‚ö° Standard" if settings.video_quality == "std" else "üé¨ Pro"
    
    await callback.message.edit_text(
        f"‚öôÔ∏è <b>–í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
        f"ü§ñ <b>–ú–æ–¥–µ–ª—å –ò–ò:</b> {model_name}\n"
        f"üìπ <b>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ:</b> {video_name}\n\n"
        f"<i>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å:</i>",
        parse_mode="HTML",
        reply_markup=settings_menu()
    )

@router.callback_query(F.data == "setting_model")
async def select_model(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏"""
    current = settings_manager.get_image_model(callback.from_user.id)
    await callback.message.edit_text(
        "ü§ñ <b>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –ò–ò</b>\n\n"
        "‚ö° <b>Flash</b> ‚Äî –±—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ\n"
        "üé® <b>Pro</b> ‚Äî –≤—ã—Å–æ—á–∞–π—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, 4K, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è\n\n"
        "<i>–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:</i>",
        parse_mode="HTML",
        reply_markup=model_selection(current)
    )

@router.callback_query(F.data.startswith("set_model_"))
async def set_model(callback: CallbackQuery):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å"""
    model = callback.data.replace("set_model_", "")
    settings_manager.update_settings(callback.from_user.id, image_model=model)
    
    model_name = "‚ö° Flash" if model == "flash" else "üé® Pro"
    await callback.answer(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å: {model_name}")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    await back_to_settings(callback)

@router.callback_query(F.data == "setting_video")
async def select_video_quality(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ"""
    current = settings_manager.get_video_quality(callback.from_user.id)
    await callback.message.edit_text(
        "üìπ <b>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ</b>\n\n"
        "‚ö° <b>Standard</b> ‚Äî –±—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è\n"
        "üé¨ <b>Pro</b> ‚Äî –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ\n\n"
        "<i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ:</i>",
        parse_mode="HTML",
        reply_markup=video_quality_selection(current)
    )

@router.callback_query(F.data.startswith("set_video_"))
async def set_video_quality(callback: CallbackQuery):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ"""
    quality = callback.data.replace("set_video_", "")
    settings_manager.update_settings(callback.from_user.id, video_quality=quality)
    
    quality_name = "‚ö° Standard" if quality == "std" else "üé¨ Pro"
    await callback.answer(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ: {quality_name}")
    
    await back_to_settings(callback)

@router.callback_query(F.data == "back_to_main")
async def back_to_main(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await callback.message.delete()
    await callback.message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu())
8. –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª (bot.py)
Python
Copy
import asyncio
import logging

from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage

from bot.config import config
from bot.handlers import start, settings, image_generation, image_editing, video_generation

logging.basicConfig(level=logging.INFO)

async def main():
    bot = Bot(token=config.BOT_TOKEN, parse_mode=ParseMode.HTML)
    dp = Dispatcher(storage=MemoryStorage())
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(start.router)
    dp.include_router(settings.router)
    dp.include_router(image_generation.router)
    dp.include_router(image_editing.router)
    dp.include_router(video_generation.router)
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
9. –°—Ç–∞—Ä—Ç (handlers/start.py)
Python
Copy
from aiogram import Router
from aiogram.types import Message
from aiogram.filters import CommandStart

from bot.keyboards import main_menu

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    await message.answer(
        "üëã <b>–ü—Ä–∏–≤–µ—Ç!</b> –Ø –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ.\n\n"
        "üé® <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b> ‚Äî —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é\n"
        "‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b> ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ\n"
        "üé¨ <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ</b> ‚Äî —Å–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é\n"
        "‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b> ‚Äî –≤—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å –ò–ò –∏ –∫–∞—á–µ—Å—Ç–≤–æ\n\n"
        "–í—Å—ë –ø—Ä–æ—Å—Ç–æ: –≤—ã–±–∏—Ä–∞–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ —Å–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º! üëá",
        parse_mode="HTML",
        reply_markup=main_menu()
    )
–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è "–±–ª–æ–Ω–¥–∏–Ω–∫–∏":
–ù–µ—Ç –ø—Ä–µ—Å–µ—Ç–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ 4 –∫–Ω–æ–ø–∫–∏ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –º–æ–¥–µ–ª—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞
–ú–∏–Ω–∏–º—É–º —à–∞–≥–æ–≤:
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –ü—Ä–æ–º–ø—Ç ‚Üí –ê—Å–ø–µ–∫—Ç ‚Üí –ì–æ—Ç–æ–≤–æ
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –§–æ—Ç–æ ‚Üí –ü—Ä–æ–º–ø—Ç ‚Üí –ê—Å–ø–µ–∫—Ç ‚Üí –ì–æ—Ç–æ–≤–æ
–í–∏–¥–µ–æ: –ü—Ä–æ–º–ø—Ç ‚Üí –ê—Å–ø–µ–∫—Ç ‚Üí –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –ì–æ—Ç–æ–≤–æ
–ù–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π ‚Äî —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∞—Å–ø–µ–∫—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
–ü–æ–Ω—è—Ç–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã ‚Äî —ç–º–æ–¥–∑–∏, –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –ø—Ä–∏–º–µ—Ä—ã
–•–æ—á–µ—à—å, –¥–æ–±–∞–≤–ª—é inline-—Ä–µ–∂–∏–º –∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏?
—Ç–∞–∫–∂–µ –¥–æ–±–∞–≤—å –ø–∞–∫–µ—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ—Ä–∞–∂–µ–Ω–∏–π. —Ñ–æ—Ç–æ –≤ –≤–∏–¥–µ–æ
Edit
Copy
Share
–î–æ–±–∞–≤–ª—è—é –ø–∞–∫–µ—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ. –í–æ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (keyboards.py)
Python
Copy
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ)
def main_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")],
            [KeyboardButton(text="üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è")],
            [KeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")],
            [KeyboardButton(text="üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ],
        resize_keyboard=True
    )

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
def settings_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª—å –ò–ò", callback_data="setting_model")],
        [InlineKeyboardButton(text="üìπ –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ", callback_data="setting_video")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")],
    ])

# –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
def model_selection(current_model: str):
    flash_check = "‚úÖ " if current_model == "flash" else ""
    pro_check = "‚úÖ " if current_model == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{flash_check}‚ö° Flash (–±—ã—Å—Ç—Ä–æ)", callback_data="set_model_flash")],
        [InlineKeyboardButton(text=f"{pro_check}üé® Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_model_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –í—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
def video_quality_selection(current_quality: str):
    std_check = "‚úÖ " if current_quality == "std" else ""
    pro_check = "‚úÖ " if current_quality == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{std_check}‚ö° Standard (–±—ã—Å—Ç—Ä–æ)", callback_data="set_video_std")],
        [InlineKeyboardButton(text=f"{pro_check}üé¨ Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_video_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
def aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="1:1", callback_data="aspect_1:1"),
            InlineKeyboardButton(text="16:9", callback_data="aspect_16:9"),
            InlineKeyboardButton(text="9:16", callback_data="aspect_9:16"),
        ],
        [
            InlineKeyboardButton(text="4:3", callback_data="aspect_4:3"),
            InlineKeyboardButton(text="3:4", callback_data="aspect_3:4"),
            InlineKeyboardButton(text="2:3", callback_data="aspect_2:3"),
        ],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –≤–∏–¥–µ–æ
def video_aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="16:9 (—à–∏—Ä–æ–∫–∏–π)", callback_data="video_aspect_16:9"),
            InlineKeyboardButton(text="9:16 (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π)", callback_data="video_aspect_9:16"),
        ],
        [InlineKeyboardButton(text="1:1 (–∫–≤–∞–¥—Ä–∞—Ç)", callback_data="video_aspect_1:1")],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ
def video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="duration_5"),
            InlineKeyboardButton(text="7 —Å–µ–∫", callback_data="duration_7"),
        ],
        [
            InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="duration_10"),
            InlineKeyboardButton(text="12 —Å–µ–∫", callback_data="duration_12"),
            InlineKeyboardButton(text="15 —Å–µ–∫", callback_data="duration_15"),
        ],
    ])

# –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
def batch_count_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="2 —à—Ç", callback_data="batch_2"),
            InlineKeyboardButton(text="4 —à—Ç", callback_data="batch_4"),
        ],
        [
            InlineKeyboardButton(text="6 —à—Ç", callback_data="batch_6"),
            InlineKeyboardButton(text="8 —à—Ç", callback_data="batch_8"),
        ],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ (—É—Ä–µ–∑–∞–Ω–Ω–∞—è)
def image_to_video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="i2v_duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="i2v_duration_5"),
        ],
        [InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="i2v_duration_10")],
    ])
2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (states.py)
Python
Copy
from aiogram.fsm.state import State, StatesGroup

class ImageGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class BatchGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_count = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class ImageEditState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class VideoGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()

class ImageToVideoState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()
3. –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (handlers/batch_generation.py)
Python
Copy
import logging
import asyncio
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, MediaGroup
from aiogram.fsm.context import FSMContext

from bot.services.gemini_service import gemini_service
from bot.services.user_settings import settings_manager
from bot.keyboards import batch_count_keyboard, aspect_ratio_keyboard, main_menu
from bot.states import BatchGenState

router = Router()
logger = logging.getLogger(__name__)

@router.message(F.text == "üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è")
async def start_batch_generation(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø–∞–∫–µ—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"""
    model = settings_manager.get_image_model(message.from_user.id)
    model_name = "‚ö° Flash" if model == "flash" else "üé® Pro"
    
    await message.answer(
        f"üì¶ <b>–ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</b>\n"
        f"–ú–æ–¥–µ–ª—å: {model_name}\n\n"
        f"‚úèÔ∏è <b>–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</b>\n"
        f"–Ø —Å–æ–∑–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
        parse_mode="HTML"
    )
    await state.set_state(BatchGenState.waiting_for_prompt)

@router.message(BatchGenState.waiting_for_prompt)
async def receive_batch_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ <i>{prompt}</i>\n\n"
        f"üî¢ <b>–°–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞—Ç—å?</b>",
        parse_mode="HTML",
        reply_markup=batch_count_keyboard()
    )
    await state.set_state(BatchGenState.waiting_for_count)

@router.callback_query(BatchGenState.waiting_for_count, F.data.startswith("batch_"))
async def receive_batch_count(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"""
    count = int(callback.data.replace("batch_", ""))
    await state.update_data(count=count)
    
    await callback.message.edit_text(
        f"üî¢ {count} —à—Ç\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç:</b>",
        parse_mode="HTML",
        reply_markup=aspect_ratio_keyboard()
    )
    await state.set_state(BatchGenState.waiting_for_aspect_ratio)

@router.callback_query(BatchGenState.waiting_for_aspect_ratio, F.data.startswith("aspect_"))
async def execute_batch_generation(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞–∫–µ—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é"""
    aspect_ratio = callback.data.replace("aspect_", "")
    data = await state.get_data()
    prompt = data["prompt"]
    count = data["count"]
    user_id = callback.from_user.id
    
    model_pref = settings_manager.get_image_model(user_id)
    model = "gemini-2.5-flash-image" if model_pref == "flash" else "gemini-3-pro-image-preview"
    
    await callback.message.edit_text(
        f"‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é {count} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...\n"
        f"–≠—Ç–æ –∑–∞–π–º—ë—Ç –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"
    )
    await state.set_state(BatchGenState.generating)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    tasks = []
    for i in range(count):
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –∫ –ø—Ä–æ–º–ø—Ç—É –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
        variation_prompt = f"{prompt}, variation {i+1}, different angle and lighting"
        task = gemini_service.generate_image(
            prompt=variation_prompt,
            model=model,
            aspect_ratio=aspect_ratio
        )
        tasks.append(task)
    
    try:
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        successful = [r for r in results if isinstance(r, bytes) and r is not None]
        
        if not successful:
            await callback.message.edit_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.",
                reply_markup=main_menu()
            )
            await state.clear()
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É (Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∞–ª—å–±–æ–º—ã)
        await callback.message.delete()
        
        await bot.send_message(
            user_id,
            f"‚úÖ –ì–æ—Ç–æ–≤–æ! {len(successful)} –∏–∑ {count}\nüìù {prompt}\nüìê {aspect_ratio}",
            reply_markup=main_menu()
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É (–∏–ª–∏ –≥—Ä—É–ø–ø–æ–π –µ—Å–ª–∏ –º–∞–ª–æ)
        if len(successful) <= 4:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞–≥—Ä—É–ø–ø–æ–π
            media = []
            for i, img in enumerate(successful[:4]):
                from aiogram.types import InputMediaPhoto
                media.append(InputMediaPhoto(
                    media=img,
                    caption=f"#{i+1}" if i == 0 else ""
                ))
            await bot.send_media_group(user_id, media=media)
        else:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É
            for i, img in enumerate(successful):
                await bot.send_photo(
                    user_id,
                    photo=img,
                    caption=f"#{i+1}"
                )
        
    except Exception as e:
        logger.exception(f"Batch generation failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.",
            reply_markup=main_menu()
        )
    
    await state.clear()
4. –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ (handlers/image_to_video.py)
Python
Copy
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, PhotoSize
from aiogram.fsm.context import FSMContext

from bot.services.kling_service import kling_service
from bot.services.user_settings import settings_manager
from bot.keyboards import video_aspect_ratio_keyboard, image_to_video_duration_keyboard, main_menu
from bot.states import ImageToVideoState

router = Router()
logger = logging.getLogger(__name__)

@router.message(F.text == "üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ")
async def start_image_to_video(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ"""
    quality = settings_manager.get_video_quality(message.from_user.id)
    quality_name = "‚ö° Standard" if quality == "std" else "üé¨ Pro"
    
    await message.answer(
        f"üñºÔ∏è <b>–§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ</b>\n"
        f"–ö–∞—á–µ—Å—Ç–≤–æ: {quality_name}\n\n"
        f"üìé <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</b>\n"
        f"–ò–∑ –Ω–µ—ë —Å–æ–∑–¥–∞–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ",
        parse_mode="HTML"
    )
    await state.set_state(ImageToVideoState.waiting_for_image)

@router.message(ImageToVideoState.waiting_for_image, F.photo)
async def receive_i2v_photo(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    photo = message.photo[-1]
    await process_i2v_image(message, photo.file_id, state)

@router.message(ImageToVideoState.waiting_for_image, F.document)
async def receive_i2v_document(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        return
    await process_i2v_image(message, doc.file_id, state)

async def process_i2v_image(message: Message, file_id: str, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ...")
    
    try:
        file = await message.bot.get_file(file_id)
        
        # –ü–æ–ª—É—á–∞–µ–º URL —Ñ–∞–π–ª–∞ (–¥–ª—è Kling –Ω—É–∂–µ–Ω URL, –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ 
        # –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º file_id –µ—Å–ª–∏ API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
        # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä/–æ–±–ª–∞–∫–æ –∏ –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π URL
        # –ó–¥–µ—Å—å —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –µ—Å—Ç—å –º–µ—Ç–æ–¥ upload_image
        
        # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º file_id –∏ –ø–æ–∑–∂–µ –∑–∞–≥—Ä—É–∑–∏–º
        await state.update_data(photo_file_id=file_id)
        
        await message.answer(
            "‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n\n"
            "‚úèÔ∏è <b>–û–ø–∏—à–∏—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ</b> (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞¬ª –∏–ª–∏ ¬´–ß–µ–ª–æ–≤–µ–∫ —É–ª—ã–±–∞–µ—Ç—Å—è¬ª\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏:",
            parse_mode="HTML",
            reply_markup=skip_prompt_keyboard()
        )
        await state.set_state(ImageToVideoState.waiting_for_prompt)
        
    except Exception as e:
        logger.exception(f"Failed to process image: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.")

def skip_prompt_keyboard():
    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="skip_prompt")]
    ])

@router.message(ImageToVideoState.waiting_for_prompt)
async def receive_i2v_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ"""
    prompt = message.text.strip()
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ {prompt}\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_aspect_ratio)

@router.callback_query(ImageToVideoState.waiting_for_prompt, F.data == "skip_prompt")
async def skip_i2v_prompt(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç"""
    await state.update_data(prompt="Animate this image naturally with subtle motion")
    
    await callback.message.edit_text(
        "‚è≠Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_aspect_ratio)

@router.callback_query(ImageToVideoState.waiting_for_aspect_ratio, F.data.startswith("video_aspect_"))
async def receive_i2v_aspect(callback: CallbackQuery, state: FSMContext):
    aspect_ratio = callback.data.replace("video_aspect_", "")
    await state.update_data(aspect_ratio=aspect_ratio)
    
    await callback.message.edit_text(
        f"üìê {aspect_ratio}\n\n"
        f"‚è± <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b>",
        parse_mode="HTML",
        reply_markup=image_to_video_duration_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_duration)

@router.callback_query(ImageToVideoState.waiting_for_duration, F.data.startswith("i2v_duration_"))
async def generate_image_to_video(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ"""
    duration = int(callback.data.replace("i2v_duration_", ""))
    data = await state.get_data()
    prompt = data.get("prompt", "Animate naturally")
    aspect_ratio = data["aspect_ratio"]
    photo_file_id = data["photo_file_id"]
    user_id = callback.from_user.id
    
    quality = settings_manager.get_video_quality(user_id)
    
    await callback.message.edit_text(
        f"‚è≥ –°–æ–∑–¥–∞—é –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ...\n"
        f"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} —Å–µ–∫"
    )
    await state.set_state(ImageToVideoState.generating)
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∏ –ø–æ–ª—É—á–∞–µ–º URL
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ S3/Imgur/etc
        # –ó–¥–µ—Å—å –∑–∞–≥–ª—É—à–∫–∞ - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –µ—Å—Ç—å –º–µ—Ç–æ–¥ upload_to_temp_hosting
        
        photo_url = await upload_photo_and_get_url(bot, photo_file_id)
        
        if not photo_url:
            await callback.message.edit_text(
                "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ.",
                reply_markup=main_menu()
            )
            await state.clear()
            return
        
        # –í—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–æ–¥
        if quality == "pro":
            result = await kling_service.generate_video_omni_pro(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio,
                start_image_url=photo_url
            )
        else:
            result = await kling_service.generate_video_omni_std(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio,
                start_image_url=photo_url
            )
        
        if result and result.get("task_id"):
            task_id = result["task_id"]
            status = await kling_service.wait_for_completion(task_id, max_attempts=60, delay=5)
            
            if status and status.get("data", {}).get("status") == "COMPLETED":
                video_url = status["data"]["result"]["video_url"]
                
                await callback.message.delete()
                await bot.send_video(
                    chat_id=user_id,
                    video=video_url,
                    caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio} | ‚è± {duration}—Å–µ–∫",
                    reply_markup=main_menu()
                )
            else:
                await callback.message.edit_text(
                    "‚ùå –í–∏–¥–µ–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ.",
                    reply_markup=main_menu()
                )
        else:
            await callback.message.edit_text(
                "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞.",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"I2V generation failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ.",
            reply_markup=main_menu()
        )
    
    await state.clear()

async def upload_photo_and_get_url(bot: Bot, file_id: str) -> str:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL.
    –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ S3, Imgur, –∏–ª–∏ —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä.
    """
    # –ó–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
    # –ù–∞–ø—Ä–∏–º–µ—Ä —á–µ—Ä–µ–∑ transfer.sh, imgur API, –∏–ª–∏ AWS S3
    
    # –ü—Ä–∏–º–µ—Ä —Å file.io –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º:
    file = await bot.get_file(file_id)
    image_bytes = await bot.download_file(file.file_path)
    
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π URL –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
    logger.info(f"Would upload image to hosting, size: {len(image_bytes.read())}")
    
    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –≤–µ—Ä–Ω—É—Ç—å URL
    return "https://example.com/temp_image.jpg"
5. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π bot.py
Python
Copy
import asyncio
import logging

from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage

from bot.config import config
from bot.handlers import (
    start, 
    settings, 
    image_generation, 
    image_editing, 
    video_generation,
    batch_generation,  # –ù–æ–≤–æ–µ
    image_to_video     # –ù–æ–≤–æ–µ
)

logging.basicConfig(level=logging.INFO)

async def main():
    bot = Bot(token=config.BOT_TOKEN, parse_mode=ParseMode.HTML)
    dp = Dispatcher(storage=MemoryStorage())
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(start.router)
    dp.include_router(settings.router)
    dp.include_router(image_generation.router)
    dp.include_router(batch_generation.router)  # –ù–æ–≤–æ–µ
    dp.include_router(image_editing.router)
    dp.include_router(video_generation.router)
    dp.include_router(image_to_video.router)    # –ù–æ–≤–æ–µ
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
6. –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ start.py
Python
Copy
@router.message(CommandStart())
async def cmd_start(message: Message):
    await message.answer(
        "üëã <b>–ü—Ä–∏–≤–µ—Ç!</b> –Ø –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ.\n\n"
        "üé® <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b> ‚Äî –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞\n"
        "üì¶ <b>–ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</b> ‚Äî —Å—Ä–∞–∑—É 2-8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\n"
        "‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b> ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ\n"
        "üé¨ <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ</b> ‚Äî –≤–∏–¥–µ–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é\n"
        "üñºÔ∏è <b>–§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ</b> ‚Äî –æ–∂–∏–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é\n"
        "‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b> ‚Äî –º–æ–¥–µ–ª—å –ò–ò –∏ –∫–∞—á–µ—Å—Ç–≤–æ\n\n"
        "–í—Å—ë –ø—Ä–æ—Å—Ç–æ: –≤—ã–±–∏—Ä–∞–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ —Å–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º! üëá",
        parse_mode="HTML",
        reply_markup=main_menu()
    )
–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:
üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Äî —Å–æ–∑–¥–∞—ë—Ç 2/4/6/8 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ —É–≥–ª–∞ –∏ –æ—Å–≤–µ—â–µ–Ω–∏—è
üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—à—å —Ñ–æ—Ç–æ, –æ–ø–∏—Å—ã–≤–∞–µ—à—å –¥–≤–∏–∂–µ–Ω–∏–µ (–∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—à—å), –≤—ã–±–∏—Ä–∞–µ—à—å —Ñ–æ—Ä–º–∞—Ç –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ–ª—É—á–∞–µ—à—å –≤–∏–¥–µ–æ
–í–∞–∂–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ:
–ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π URL (Kling API —Ç—Ä–µ–±—É–µ—Ç URL). –í–∞—Ä–∏–∞–Ω—Ç—ã:
Imgur API ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø—Ä–æ—Å—Ç–æ
Transfer.sh ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
AWS S3 ‚Äî –Ω–∞–¥—ë–∂–Ω–æ, –Ω–æ –ø–ª–∞—Ç–Ω–æ
–°–≤–æ–π —Å–µ—Ä–≤–µ—Ä ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å
–•–æ—á–µ—à—å, –¥–æ–±–∞–≤–ª—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Imgur –∏–ª–∏ AWS S3?
—Ñ–∞–π–ª—ã –ø—Ä–∏—Å–ª–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–æ–º —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è–≤ —Å—Ç–∞—Ç–∏–∫ –∏ –¥–∞–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π url
Edit
Copy
Share
–û—Ç–ª–∏—á–Ω–æ! –¢–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ /static –∏ –≤—ã–¥–∞—á—É –ø—É–±–ª–∏—á–Ω—ã—Ö URL. –í–æ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π config.py (–¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏)
Python
Copy
import os
from pathlib import Path

# –ë–∞–∑–æ–≤—ã–µ –ø—É—Ç–∏
BASE_DIR = Path(__file__).parent.parent
STATIC_DIR = BASE_DIR / "static"
STATIC_URL = os.getenv("STATIC_URL", "https://your-domain.com/static")

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –Ω–µ—Ç
STATIC_DIR.mkdir(parents=True, exist_ok=True)

# Bot token
BOT_TOKEN = os.getenv("BOT_TOKEN")

# API Keys
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
NANOBANANA_API_KEY = os.getenv("NANOBANANA_API_KEY")
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
FREEPIK_API_KEY = os.getenv("FREEPIK_API_KEY")

# Base URLs
NANOBANANA_BASE_URL = os.getenv("NANOBANANA_BASE_URL", "https://api.nanobanana.com")
OPENROUTER_BASE_URL = os.getenv("OPENROUTER_BASE_URL", "https://openrouter.ai/api")
FREEPIK_BASE_URL = os.getenv("FREEPIK_BASE_URL", "https://api.freepik.com/v1")
2. –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ (services/file_storage.py)
Python
Copy
import logging
import uuid
from pathlib import Path
from typing import Optional

from aiogram import Bot

from bot.config import config

logger = logging.getLogger(__name__)


class FileStorage:
    """–•—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤ –≤ static —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ URL"""
    
    def __init__(self):
        self.static_dir = config.STATIC_DIR
        self.static_url = config.STATIC_URL.rstrip("/")
        self.static_dir.mkdir(parents=True, exist_ok=True)
        
        # –ü–æ–¥–ø–∞–ø–∫–∏ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        self.images_dir = self.static_dir / "images"
        self.videos_dir = self.static_dir / "videos"
        
        self.images_dir.mkdir(exist_ok=True)
        self.videos_dir.mkdir(exist_ok=True)
    
    def _generate_filename(self, extension: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞"""
        return f"{uuid.uuid4().hex}{extension}"
    
    def _get_public_url(self, relative_path: str) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL –¥–ª—è —Ñ–∞–π–ª–∞"""
        return f"{self.static_url}/{relative_path}"
    
    async def save_image_from_telegram(
        self, 
        bot: Bot, 
        file_id: str,
        user_id: int
    ) -> Optional[str]:
        """
        –°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∏–∑ Telegram –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ static/images/
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL
        """
        try:
            # –°–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∞–ø–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_dir = self.images_dir / str(user_id)
            user_dir.mkdir(exist_ok=True)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª
            file = await bot.get_file(file_id)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
            file_path = file.file_path
            extension = Path(file_path).suffix or ".jpg"
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è
            filename = self._generate_filename(extension)
            local_path = user_dir / filename
            
            # –°–∫–∞—á–∏–≤–∞–µ–º
            await bot.download_file(file_path, destination=str(local_path))
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è URL
            relative_path = f"images/{user_id}/{filename}"
            public_url = self._get_public_url(relative_path)
            
            logger.info(f"Saved image: {local_path} -> {public_url}")
            return public_url
            
        except Exception as e:
            logger.exception(f"Failed to save image: {e}")
            return None
    
    async def save_bytes_as_image(
        self,
        image_bytes: bytes,
        user_id: int,
        extension: str = ".png"
    ) -> Optional[str]:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL
        """
        try:
            user_dir = self.images_dir / str(user_id)
            user_dir.mkdir(exist_ok=True)
            
            filename = self._generate_filename(extension)
            local_path = user_dir / filename
            
            with open(local_path, "wb") as f:
                f.write(image_bytes)
            
            relative_path = f"images/{user_id}/{filename}"
            public_url = self._get_public_url(relative_path)
            
            logger.info(f"Saved bytes as image: {local_path}")
            return public_url
            
        except Exception as e:
            logger.exception(f"Failed to save image bytes: {e}")
            return None
    
    def cleanup_old_files(self, max_age_hours: int = 24):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ (–º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é)"""
        import time
        from datetime import datetime, timedelta
        
        cutoff = time.time() - (max_age_hours * 3600)
        deleted = 0
        
        for directory in [self.images_dir, self.videos_dir]:
            if not directory.exists():
                continue
                
            for file_path in directory.rglob("*"):
                if file_path.is_file():
                    try:
                        if file_path.stat().st_mtime < cutoff:
                            file_path.unlink()
                            deleted += 1
                    except Exception as e:
                        logger.error(f"Failed to delete {file_path}: {e}")
        
        logger.info(f"Cleaned up {deleted} old files")
        return deleted


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å
file_storage = FileStorage()
3. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π image_to_video.py (–∏—Å–ø–æ–ª—å–∑—É–µ–º static)
Python
Copy
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, PhotoSize
from aiogram.fsm.context import FSMContext

from bot.services.kling_service import kling_service
from bot.services.user_settings import settings_manager
from bot.services.file_storage import file_storage
from bot.keyboards import video_aspect_ratio_keyboard, image_to_video_duration_keyboard, main_menu
from bot.states import ImageToVideoState

router = Router()
logger = logging.getLogger(__name__)


def skip_prompt_keyboard():
    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="skip_prompt")]
    ])


@router.message(F.text == "üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ")
async def start_image_to_video(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ"""
    quality = settings_manager.get_video_quality(message.from_user.id)
    quality_name = "‚ö° Standard" if quality == "std" else "üé¨ Pro"
    
    await message.answer(
        f"üñºÔ∏è <b>–§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ</b>\n"
        f"–ö–∞—á–µ—Å—Ç–≤–æ: {quality_name}\n\n"
        f"üìé <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</b>\n"
        f"–ò–∑ –Ω–µ—ë —Å–æ–∑–¥–∞–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ",
        parse_mode="HTML"
    )
    await state.set_state(ImageToVideoState.waiting_for_image)


@router.message(ImageToVideoState.waiting_for_image, F.photo)
async def receive_i2v_photo(message: Message, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    photo = message.photo[-1]
    await process_i2v_image(message, bot, photo.file_id, state)


@router.message(ImageToVideoState.waiting_for_image, F.document)
async def receive_i2v_document(message: Message, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        return
    await process_i2v_image(message, bot, doc.file_id, state)


async def process_i2v_image(message: Message, bot: Bot, file_id: str, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ...")
    
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ static –∏ –ø–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
        photo_url = await file_storage.save_image_from_telegram(
            bot=bot,
            file_id=file_id,
            user_id=message.from_user.id
        )
        
        if not photo_url:
            await message.answer("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ.")
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.update_data(photo_url=photo_url)
        
        await message.answer(
            "‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n\n"
            "‚úèÔ∏è <b>–û–ø–∏—à–∏—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ</b> (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞¬ª –∏–ª–∏ ¬´–ß–µ–ª–æ–≤–µ–∫ —É–ª—ã–±–∞–µ—Ç—Å—è¬ª\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏:",
            parse_mode="HTML",
            reply_markup=skip_prompt_keyboard()
        )
        await state.set_state(ImageToVideoState.waiting_for_prompt)
        
    except Exception as e:
        logger.exception(f"Failed to process image: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.")


@router.message(ImageToVideoState.waiting_for_prompt)
async def receive_i2v_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ"""
    prompt = message.text.strip()
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ {prompt}\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_aspect_ratio)


@router.callback_query(ImageToVideoState.waiting_for_prompt, F.data == "skip_prompt")
async def skip_i2v_prompt(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç"""
    await state.update_data(prompt="Animate this image naturally with subtle motion")
    
    await callback.message.edit_text(
        "‚è≠Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_aspect_ratio)


@router.callback_query(ImageToVideoState.waiting_for_aspect_ratio, F.data.startswith("video_aspect_"))
async def receive_i2v_aspect(callback: CallbackQuery, state: FSMContext):
    aspect_ratio = callback.data.replace("video_aspect_", "")
    await state.update_data(aspect_ratio=aspect_ratio)
    
    await callback.message.edit_text(
        f"üìê {aspect_ratio}\n\n"
        f"‚è± <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b>",
        parse_mode="HTML",
        reply_markup=image_to_video_duration_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_duration)


@router.callback_query(ImageToVideoState.waiting_for_duration, F.data.startswith("i2v_duration_"))
async def generate_image_to_video(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ"""
    duration = int(callback.data.replace("i2v_duration_", ""))
    data = await state.get_data()
    prompt = data.get("prompt", "Animate naturally")
    aspect_ratio = data["aspect_ratio"]
    photo_url = data["photo_url"]  # –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä—è–º–æ–π URL!
    user_id = callback.from_user.id
    
    quality = settings_manager.get_video_quality(user_id)
    
    await callback.message.edit_text(
        f"‚è≥ –°–æ–∑–¥–∞—é –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ...\n"
        f"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} —Å–µ–∫\n"
        f"‚è± –û–∂–∏–¥–∞–Ω–∏–µ: 2-5 –º–∏–Ω—É—Ç"
    )
    await state.set_state(ImageToVideoState.generating)
    
    try:
        # –í—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞
        if quality == "pro":
            result = await kling_service.generate_video_omni_pro(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio,
                start_image_url=photo_url  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –ø—É–±–ª–∏—á–Ω—ã–π URL!
            )
        else:
            result = await kling_service.generate_video_omni_std(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio,
                start_image_url=photo_url
            )
        
        if result and result.get("task_id"):
            task_id = result["task_id"]
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—à—ë–ª
            await callback.message.edit_text(
                f"üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞—Ç–∞...\n"
                f"ID –∑–∞–¥–∞—á–∏: {task_id}\n"
                f"–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å..."
            )
            
            status = await kling_service.wait_for_completion(task_id, max_attempts=60, delay=5)
            
            if status and status.get("data", {}).get("status") == "COMPLETED":
                video_url = status["data"]["result"]["video_url"]
                
                await callback.message.delete()
                await bot.send_video(
                    chat_id=user_id,
                    video=video_url,
                    caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio} | ‚è± {duration}—Å–µ–∫",
                    reply_markup=main_menu()
                )
            else:
                error_msg = status.get("data", {}).get("error", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞") if status else "–¢–∞–π–º–∞—É—Ç"
                await callback.message.edit_text(
                    f"‚ùå –í–∏–¥–µ–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ.\n–û—à–∏–±–∫–∞: {error_msg}",
                    reply_markup=main_menu()
                )
        else:
            error = result.get("error") if result else "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API"
            await callback.message.edit_text(
                f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞.\n{error}",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"I2V generation failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=main_menu()
        )
    
    await state.clear()
4. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π image_editing.py (—Ç–æ–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ static –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
Python
Copy
import logging
import io
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, PhotoSize
from aiogram.fsm.context import FSMContext

from bot.services.gemini_service import gemini_service
from bot.services.user_settings import settings_manager
from bot.services.file_storage import file_storage  # –î–æ–±–∞–≤–∏–ª–∏
from bot.keyboards import aspect_ratio_keyboard, main_menu
from bot.states import ImageEditState

router = Router()
logger = logging.getLogger(__name__)


@router.message(F.text == "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
async def start_image_editing(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    await message.answer(
        "‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b>\n\n"
        "üìé <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b> (—Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª)\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG",
        parse_mode="HTML"
    )
    await state.set_state(ImageEditState.waiting_for_image)


@router.message(ImageEditState.waiting_for_image, F.photo)
async def receive_photo(message: Message, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    photo = message.photo[-1]
    await process_image(message, bot, photo.file_id, state)


@router.message(ImageEditState.waiting_for_image, F.document)
async def receive_document(message: Message, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG –∏–ª–∏ PNG)")
        return
    await process_image(message, bot, doc.file_id, state)


async def process_image(message: Message, bot: Bot, file_id: str, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
    
    try:
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await bot.get_file(file_id)
        image_bytes_io = await bot.download_file(file.file_path)
        image_data = image_bytes_io.read()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        await state.update_data(image=image_data)
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ static –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏/–ª–æ–≥–æ–≤
        # public_url = await file_storage.save_bytes_as_image(
        #     image_bytes=image_data,
        #     user_id=message.from_user.id
        # )
        
        await message.answer(
            "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n\n"
            "‚úèÔ∏è <b>–ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å?</b>\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
            "‚Ä¢ ¬´–°–¥–µ–ª–∞–π —Ñ–æ–Ω —Å–∏–Ω–∏–º¬ª\n"
            "‚Ä¢ ¬´–î–æ–±–∞–≤—å —Å–æ–ª–Ω–µ—á–Ω—ã–µ –æ—á–∫–∏¬ª\n"
            "‚Ä¢ ¬´–ü—Ä–µ–≤—Ä–∞—Ç–∏ –≤ –º—É–ª—å—Ç—Ñ–∏–ª—å–º¬ª",
            parse_mode="HTML"
        )
        await state.set_state(ImageEditState.waiting_for_prompt)
        
    except Exception as e:
        logger.exception(f"Failed to process image: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ.")


@router.message(ImageEditState.waiting_for_prompt)
async def receive_edit_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ –ó–∞–¥–∞—á–∞: <i>{prompt}</i>\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:</b>",
        parse_mode="HTML",
        reply_markup=aspect_ratio_keyboard()
    )
    await state.set_state(ImageEditState.waiting_for_aspect_ratio)


@router.callback_query(ImageEditState.waiting_for_aspect_ratio, F.data.startswith("aspect_"))
async def execute_edit(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    aspect_ratio = callback.data.replace("aspect_", "")
    data = await state.get_data()
    prompt = data["prompt"]
    image_data = data["image"]
    user_id = callback.from_user.id
    
    model_pref = settings_manager.get_image_model(user_id)
    model = "gemini-2.5-flash-image" if model_pref == "flash" else "gemini-3-pro-image-preview"
    
    await callback.message.edit_text("‚è≥ –†–µ–¥–∞–∫—Ç–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
    await state.set_state(ImageEditState.generating)
    
    try:
        result = await gemini_service.edit_image(
            image_bytes=image_data,
            instruction=prompt,
            model=model,
            aspect_ratio=aspect_ratio
        )
        
        if result:
            await callback.message.delete()
            await bot.send_photo(
                chat_id=user_id,
                photo=result,
                caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio}",
                reply_markup=main_menu()
            )
        else:
            await callback.message.edit_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"Image editing failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=main_menu()
        )
    
    await state.clear()
5. –î–æ–±–∞–≤–ª—è–µ–º –æ—á–∏—Å—Ç–∫—É –≤ bot.py (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
Python
Copy
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage

from bot.config import config
from bot.handlers import (
    start, 
    settings, 
    image_generation, 
    image_editing, 
    video_generation,
    batch_generation,
    image_to_video
)
from bot.services.file_storage import file_storage

logging.basicConfig(level=logging.INFO)

async def cleanup_task():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"""
    while True:
        await asyncio.sleep(3600)  # –ö–∞–∂–¥—ã–π —á–∞—Å
        try:
            deleted = file_storage.cleanup_old_files(max_age_hours=24)
            logging.info(f"Cleanup completed: {deleted} files deleted")
        except Exception as e:
            logging.error(f"Cleanup error: {e}")

async def main():
    bot = Bot(token=config.BOT_TOKEN, parse_mode=ParseMode.HTML)
    dp = Dispatcher(storage=MemoryStorage())
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(start.router)
    dp.include_router(settings.router)
    dp.include_router(image_generation.router)
    dp.include_router(batch_generation.router)
    dp.include_router(image_editing.router)
    dp.include_router(video_generation.router)
    dp.include_router(image_to_video.router)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É –≤ —Ñ–æ–Ω–µ
    asyncio.create_task(cleanup_task())
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
6. –ü—Ä–∏–º–µ—Ä nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ static)
nginx
Copy
server {
    listen 80;
    server_name your-domain.com;
    
    location /static/ {
        alias /path/to/your/bot/static/;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
plain
Copy
bot/
‚îú‚îÄ‚îÄ static/                    # –ü—É–±–ª–∏—á–Ω–∞—è –ø–∞–ø–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {user_id}/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ {uuid}.jpg
‚îÇ   ‚îî‚îÄ‚îÄ videos/
‚îú‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ file_storage.py        # –ù–æ–≤–æ–µ
‚îÇ   ‚îú‚îÄ‚îÄ user_settings.py
‚îÇ   ‚îú‚îÄ‚îÄ gemini_service.py
‚îÇ   ‚îî‚îÄ‚îÄ kling_service.py
‚îî‚îÄ‚îÄ handlers/
    ‚îú‚îÄ‚îÄ image_to_video.py      # –û–±–Ω–æ–≤–ª—ë–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç file_storage)
    ‚îî‚îÄ‚îÄ ...
–¢–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ /static/images/{user_id}/{uuid}.jpg –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ https://your-domain.com/static/images/{user_id}/{uuid}.jpg ‚Äî Kling API –º–æ–∂–µ—Ç –∏—Ö —Å–∫–∞—á–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é!
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å webhook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–ø–∫–∏?
–ø–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ
Edit
Copy
Share
–î–æ–±–∞–≤–ª—è—é –ø–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ, –ø–∏—à–µ—Ç –æ–¥–∏–Ω –ø—Ä–æ–º–ø—Ç, –∏ –±–æ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –≤—Å–µ —Å—Ä–∞–∑—É.
1. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (keyboards.py)
Python
Copy
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ)
def main_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")],
            [KeyboardButton(text="üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è")],
            [KeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")],
            [InlineKeyboardButton(text="üìÇ –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")],
            [KeyboardButton(text="üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ],
        resize_keyboard=True
    )

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
def settings_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª—å –ò–ò", callback_data="setting_model")],
        [InlineKeyboardButton(text="üìπ –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ", callback_data="setting_video")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")],
    ])

# –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
def model_selection(current_model: str):
    flash_check = "‚úÖ " if current_model == "flash" else ""
    pro_check = "‚úÖ " if current_model == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{flash_check}‚ö° Flash (–±—ã—Å—Ç—Ä–æ)", callback_data="set_model_flash")],
        [InlineKeyboardButton(text=f"{pro_check}üé® Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_model_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –í—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
def video_quality_selection(current_quality: str):
    std_check = "‚úÖ " if current_quality == "std" else ""
    pro_check = "‚úÖ " if current_quality == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{std_check}‚ö° Standard (–±—ã—Å—Ç—Ä–æ)", callback_data="set_video_std")],
        [InlineKeyboardButton(text=f"{pro_check}üé¨ Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_video_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
def aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="1:1", callback_data="aspect_1:1"),
            InlineKeyboardButton(text="16:9", callback_data="aspect_16:9"),
            InlineKeyboardButton(text="9:16", callback_data="aspect_9:16"),
        ],
        [
            InlineKeyboardButton(text="4:3", callback_data="aspect_4:3"),
            InlineKeyboardButton(text="3:4", callback_data="aspect_3:4"),
            InlineKeyboardButton(text="2:3", callback_data="aspect_2:3"),
        ],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –≤–∏–¥–µ–æ
def video_aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="16:9 (—à–∏—Ä–æ–∫–∏–π)", callback_data="video_aspect_16:9"),
            InlineKeyboardButton(text="9:16 (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π)", callback_data="video_aspect_9:16"),
        ],
        [InlineKeyboardButton(text="1:1 (–∫–≤–∞–¥—Ä–∞—Ç)", callback_data="video_aspect_1:1")],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ
def video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="duration_5"),
            InlineKeyboardButton(text="7 —Å–µ–∫", callback_data="duration_7"),
        ],
        [
            InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="duration_10"),
            [InlineKeyboardButton(text="12 —Å–µ–∫", callback_data="duration_12")],
            [InlineKeyboardButton(text="15 —Å–µ–∫", callback_data="duration_15")],
        ],
    ])

# –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
def batch_count_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="2 —à—Ç", callback_data="batch_2"),
            InlineKeyboardButton(text="4 —à—Ç", callback_data="batch_4"),
        ],
        [
            InlineKeyboardButton(text="6 —à—Ç", callback_data="batch_6"),
            InlineKeyboardButton(text="8 —à—Ç", callback_data="batch_8"),
        ],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ
def image_to_video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="i2v_duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="i2v_duration_5"),
        ],
        [InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="i2v_duration_10")],
    ])

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –≥–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ
def batch_edit_ready_keyboard(count: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"‚úÖ –ì–æ—Ç–æ–≤–æ ({count} —Ñ–æ—Ç–æ)", callback_data="batch_edit_ready")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="batch_edit_cancel")],
    ])

# –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ –∏–ª–∏ –≥–æ—Ç–æ–≤–æ
def batch_edit_add_more_keyboard(count: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"üìé –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë", callback_data="batch_edit_add")],
        [InlineKeyboardButton(text=f"‚úÖ –ì–æ—Ç–æ–≤–æ ({count})", callback_data="batch_edit_ready")],
    ])
2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (states.py)
Python
Copy
from aiogram.fsm.state import State, StatesGroup

class ImageGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class BatchGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_count = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class ImageEditState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class BatchEditState(StatesGroup):
    collecting_images = State()      # –°–æ–±–∏—Ä–∞–µ–º —Ñ–æ—Ç–æ
    waiting_for_prompt = State()     # –ñ–¥—ë–º –ø—Ä–æ–º–ø—Ç
    waiting_for_aspect_ratio = State()  # –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞
    generating = State()             # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è

class VideoGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()

class ImageToVideoState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()
3. –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (handlers/batch_editing.py)
Python
Copy
import logging
import asyncio
from typing import List
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, BufferedInputFile
from aiogram.fsm.context import FSMContext

from bot.services.gemini_service import gemini_service
from bot.services.user_settings import settings_manager
from bot.keyboards import (
    aspect_ratio_keyboard, 
    main_menu, 
    batch_edit_ready_keyboard,
    batch_edit_add_more_keyboard
)
from bot.states import BatchEditState

router = Router()
logger = logging.getLogger(__name__)

MAX_BATCH_EDIT_IMAGES = 10  # –ú–∞–∫—Å–∏–º—É–º —Ñ–æ—Ç–æ –∑–∞ —Ä–∞–∑


@router.message(F.text == "üìÇ –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
async def start_batch_editing(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    await state.update_data(images=[], image_count=0)
    
    await message.answer(
        "üìÇ <b>–ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n\n"
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</b>, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ.\n\n"
        "üìé <b>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É</b> –∏–ª–∏ –≥—Ä—É–ø–ø–æ–π\n"
        f"–ú–∞–∫—Å–∏–º—É–º: {MAX_BATCH_EDIT_IMAGES} —à—Ç\n\n"
        "–ö–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Å–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª",
        parse_mode="HTML",
        reply_markup=batch_edit_ready_keyboard(0)
    )
    await state.set_state(BatchEditState.collecting_images)


@router.message(BatchEditState.collecting_images, F.photo)
async def receive_batch_photo(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    data = await state.get_data()
    images: List[bytes] = data.get("images", [])
    count = data.get("image_count", 0)
    
    if count >= MAX_BATCH_EDIT_IMAGES:
        await message.answer(
            f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç ({MAX_BATCH_EDIT_IMAGES} —Ñ–æ—Ç–æ)\n"
            f"–ù–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è",
            reply_markup=batch_edit_ready_keyboard(count)
        )
        return
    
    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
    try:
        photo = message.photo[-1]
        file = await message.bot.get_file(photo.file_id)
        image_bytes = await message.bot.download_file(file.file_path)
        image_data = image_bytes.read()
        
        images.append(image_data)
        count += 1
        
        await state.update_data(images=images, image_count=count)
        
        await message.answer(
            f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {count} —Ñ–æ—Ç–æ\n"
            f"üìé –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –∏–ª–∏ –Ω–∞–∂–∞—Ç—å ¬´–ì–æ—Ç–æ–≤–æ¬ª",
            reply_markup=batch_edit_add_more_keyboard(count)
        )
        
    except Exception as e:
        logger.exception(f"Failed to download photo: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ")


@router.message(BatchEditState.collecting_images, F.document)
async def receive_batch_document(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        return
    
    data = await state.get_data()
    images: List[bytes] = data.get("images", [])
    count = data.get("image_count", 0)
    
    if count >= MAX_BATCH_EDIT_IMAGES:
        await message.answer(
            f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç ({MAX_BATCH_EDIT_IMAGES} —Ñ–æ—Ç–æ)",
            reply_markup=batch_edit_ready_keyboard(count)
        )
        return
    
    try:
        file = await message.bot.get_file(doc.file_id)
        image_bytes = await message.bot.download_file(file.file_path)
        image_data = image_bytes.read()
        
        images.append(image_data)
        count += 1
        
        await state.update_data(images=images, image_count=count)
        
        await message.answer(
            f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {count} —Ñ–æ—Ç–æ",
            reply_markup=batch_edit_add_more_keyboard(count)
        )
        
    except Exception as e:
        logger.exception(f"Failed to download document: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞")


@router.callback_query(BatchEditState.collecting_images, F.data == "batch_edit_add")
async def continue_adding(callback: CallbackQuery):
    """–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å"""
    await callback.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ")


@router.callback_query(BatchEditState.collecting_images, F.data == "batch_edit_ready")
async def finish_collecting(callback: CallbackQuery, state: FSMContext):
    """–ó–∞–∫–æ–Ω—á–∏–ª–∏ —Å–æ–±–∏—Ä–∞—Ç—å —Ñ–æ—Ç–æ"""
    data = await state.get_data()
    images = data.get("images", [])
    count = data.get("image_count", 0)
    
    if count == 0:
        await callback.answer("‚ùå –ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ!")
        return
    
    if count == 1:
        await callback.message.edit_text(
            "‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ 1 —Ñ–æ—Ç–æ.\n"
            "–î–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ¬ª\n\n"
            "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ –∏–ª–∏ –æ—Ç–º–µ–Ω–∞?",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data="batch_continue_anyway")],
                [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="batch_edit_cancel")],
            ])
        )
        return
    
    await proceed_to_prompt(callback, state)


@router.callback_query(BatchEditState.collecting_images, F.data == "batch_continue_anyway")
async def continue_single(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ —Å 1 —Ñ–æ—Ç–æ"""
    await proceed_to_prompt(callback, state)


async def proceed_to_prompt(callback: CallbackQuery, state: FSMContext):
    """–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –ø—Ä–æ–º–ø—Ç–∞"""
    data = await state.get_data()
    count = data.get("image_count", 0)
    
    await callback.message.edit_text(
        f"‚úÖ <b>{count} —Ñ–æ—Ç–æ</b> –ø—Ä–∏–Ω—è—Ç–æ!\n\n"
        f"‚úèÔ∏è <b>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å–æ –≤—Å–µ–º–∏ —Ñ–æ—Ç–æ?</b>\n"
        f"–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        f"‚Ä¢ ¬´–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç¬ª\n"
        f"‚Ä¢ ¬´–°–¥–µ–ª–∞—Ç—å —á—ë—Ä–Ω–æ-–±–µ–ª—ã–º¬ª\n"
        f"‚Ä¢ ¬´–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–º–∫—É¬ª\n"
        f"‚Ä¢ ¬´–£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ¬ª",
        parse_mode="HTML"
    )
    await state.set_state(BatchEditState.waiting_for_prompt)


@router.message(BatchEditState.waiting_for_prompt)
async def receive_batch_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ –ó–∞–¥–∞—á–∞: <i>{prompt}</i>\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ:</b>",
        parse_mode="HTML",
        reply_markup=aspect_ratio_keyboard()
    )
    await state.set_state(BatchEditState.waiting_for_aspect_ratio)


@router.callback_query(BatchEditState.waiting_for_aspect_ratio, F.data.startswith("aspect_"))
async def execute_batch_edit(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    aspect_ratio = callback.data.replace("aspect_", "")
    data = await state.get_data()
    prompt = data["prompt"]
    images: List[bytes] = data["images"]
    count = len(images)
    user_id = callback.from_user.id
    
    model_pref = settings_manager.get_image_model(user_id)
    model = "gemini-2.5-flash-image" if model_pref == "flash" else "gemini-3-pro-image-preview"
    
    await callback.message.edit_text(
        f"‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é {count} —Ñ–æ—Ç–æ...\n"
        f"–ó–∞–¥–∞—á–∞: {prompt}\n"
        f"0/{count} –≥–æ—Ç–æ–≤–æ"
    )
    await state.set_state(BatchEditState.generating)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
    semaphore = asyncio.Semaphore(3)  # –ú–∞–∫—Å 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    
    async def edit_single(index: int, image_data: bytes) -> tuple:
        async with semaphore:
            try:
                result = await gemini_service.edit_image(
                    image_bytes=image_data,
                    instruction=prompt,
                    model=model,
                    aspect_ratio=aspect_ratio
                )
                return (index, result, None)
            except Exception as e:
                logger.exception(f"Failed to edit image {index}: {e}")
                return (index, None, str(e))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
    tasks = [edit_single(i, img) for i, img in enumerate(images)]
    results = await asyncio.gather(*tasks)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É
    results.sort(key=lambda x: x[0])
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    successful = 0
    failed = 0
    
    await callback.message.delete()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º –≤—ã–≥—Ä—É–∑–∫—É
    status_msg = await bot.send_message(
        user_id,
        f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
    )
    
    for index, result, error in results:
        if result:
            successful += 1
            await bot.send_photo(
                chat_id=user_id,
                photo=BufferedInputFile(result, filename=f"edited_{index+1}.png"),
                caption=f"‚úÖ #{index+1}"
            )
        else:
            failed += 1
            await bot.send_message(
                user_id,
                f"‚ùå #{index+1} ‚Äî –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"
            )
    
    # –ò—Ç–æ–≥
    await status_msg.delete()
    await bot.send_message(
        user_id,
        f"‚úÖ <b>–ì–æ—Ç–æ–≤–æ!</b>\n\n"
        f"üìù –ó–∞–¥–∞—á–∞: {prompt}\n"
        f"üìê –§–æ—Ä–º–∞—Ç: {aspect_ratio}\n"
        f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {successful}/{count}\n"
        f"‚ùå –û—à–∏–±–æ–∫: {failed}",
        parse_mode="HTML",
        reply_markup=main_menu()
    )
    
    await state.clear()


@router.callback_query(F.data == "batch_edit_cancel")
async def cancel_batch_edit(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞"""
    await callback.message.edit_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ")
    await callback.message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu())
    await state.clear()
4. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π bot.py
Python
Copy
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage

from bot.config import config
from bot.handlers import (
    start, 
    settings, 
    image_generation, 
    image_editing, 
    video_generation,
    batch_generation,
    batch_editing,      # –ù–æ–≤–æ–µ
    image_to_video
)
from bot.services.file_storage import file_storage

logging.basicConfig(level=logging.INFO)

async def cleanup_task():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"""
    while True:
        await asyncio.sleep(3600)
        try:
            deleted = file_storage.cleanup_old_files(max_age_hours=24)
            logging.info(f"Cleanup completed: {deleted} files deleted")
        except Exception as e:
            logging.error(f"Cleanup error: {e}")

async def main():
    bot = Bot(token=config.BOT_TOKEN, parse_mode=ParseMode.HTML)
    dp = Dispatcher(storage=MemoryStorage())
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(start.router)
    dp.include_router(settings.router)
    dp.include_router(image_generation.router)
    dp.include_router(batch_generation.router)
    dp.include_router(image_editing.router)
    dp.include_router(batch_editing.router)     # –ù–æ–≤–æ–µ
    dp.include_router(video_generation.router)
    dp.include_router(image_to_video.router)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É –≤ —Ñ–æ–Ω–µ
    asyncio.create_task(cleanup_task())
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
5. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π start.py
Python
Copy
from aiogram import Router
from aiogram.types import Message
from aiogram.filters import CommandStart

from bot.keyboards import main_menu

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    await message.answer(
        "üëã <b>–ü—Ä–∏–≤–µ—Ç!</b> –Ø –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ.\n\n"
        "üé® <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b> ‚Äî –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞\n"
        "üì¶ <b>–ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</b> ‚Äî —Å—Ä–∞–∑—É 2-8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\n"
        "‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b> ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–Ω–æ —Ñ–æ—Ç–æ\n"
        "üìÇ <b>–ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b> ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –º–Ω–æ–≥–æ —Ñ–æ—Ç–æ —Ä–∞–∑–æ–º\n"
        "üé¨ <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ</b> ‚Äî –≤–∏–¥–µ–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é\n"
        "üñºÔ∏è <b>–§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ</b> ‚Äî –æ–∂–∏–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é\n"
        "‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b> ‚Äî –º–æ–¥–µ–ª—å –ò–ò –∏ –∫–∞—á–µ—Å—Ç–≤–æ\n\n"
        "–í—Å—ë –ø—Ä–æ—Å—Ç–æ: –≤—ã–±–∏—Ä–∞–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ —Å–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º! üëá",
        parse_mode="HTML",
        reply_markup=main_menu()
    )
–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç ¬´üìÇ –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª
–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É –∏–ª–∏ –≥—Ä—É–ø–ø–æ–π (–¥–æ 10 —à—Ç)
–ñ–º—ë—Ç ¬´–ì–æ—Ç–æ–≤–æ¬ª –∫–æ–≥–¥–∞ –≤—Å—ë –∑–∞–≥—Ä—É–∂–µ–Ω–æ
–í–≤–æ–¥–∏—Ç –ø—Ä–æ–º–ø—Ç ‚Äî —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å–æ –≤—Å–µ–º–∏ —Ñ–æ—Ç–æ
–í—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç ‚Äî –≤—Å–µ —Ñ–æ—Ç–æ –±—É–¥—É—Ç –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
–ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–º–∞–∫—Å 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
–ü—Ä–∏—Å—ã–ª–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –æ–¥–Ω–æ–º—É —Å –Ω–æ–º–µ—Ä–∞–º–∏
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Äî –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏
–°–µ–º–∞—Ñ–æ—Ä ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ (—á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∞–Ω–∏–ª–∏)
–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–æ
–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚Äî –µ—Å–ª–∏ –æ–¥–Ω–æ —Ñ–æ—Ç–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–æ—Å—å, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–∏–¥—É—Ç
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ —á—Ç–æ –∏ –∑–∞–≥—Ä—É–∑–∫–∞
–•–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∫ —Ä–∞–∑–Ω—ã–º —Ñ–æ—Ç–æ?
–Ω–∞–ø–∏—à–∏ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
Edit
Copy
Share
–í–æ—Ç –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:
1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π keyboards.py
Python
Copy
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —É–±—Ä–∞–Ω InlineKeyboardButton)
def main_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")],
            [KeyboardButton(text="üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è")],
            [KeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")],
            [KeyboardButton(text="üìÇ –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")],  # –ë—ã–ª–æ InlineKeyboardButton
            [KeyboardButton(text="üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ")],
            [KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ],
        resize_keyboard=True
    )

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
def settings_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ü§ñ –ú–æ–¥–µ–ª—å –ò–ò", callback_data="setting_model")],
        [InlineKeyboardButton(text="üìπ –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ", callback_data="setting_video")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")],
    ])

# –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
def model_selection(current_model: str):
    flash_check = "‚úÖ " if current_model == "flash" else ""
    pro_check = "‚úÖ " if current_model == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{flash_check}‚ö° Flash (–±—ã—Å—Ç—Ä–æ)", callback_data="set_model_flash")],
        [InlineKeyboardButton(text=f"{pro_check}üé® Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_model_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –í—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
def video_quality_selection(current_quality: str):
    std_check = "‚úÖ " if current_quality == "std" else ""
    pro_check = "‚úÖ " if current_quality == "pro" else ""
    
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{std_check}‚ö° Standard (–±—ã—Å—Ç—Ä–æ)", callback_data="set_video_std")],
        [InlineKeyboardButton(text=f"{pro_check}üé¨ Pro (–∫–∞—á–µ—Å—Ç–≤–æ)", callback_data="set_video_pro")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="settings")],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
def aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="1:1", callback_data="aspect_1:1"),
            InlineKeyboardButton(text="16:9", callback_data="aspect_16:9"),
            InlineKeyboardButton(text="9:16", callback_data="aspect_9:16"),
        ],
        [
            InlineKeyboardButton(text="4:3", callback_data="aspect_4:3"),
            InlineKeyboardButton(text="3:4", callback_data="aspect_3:4"),
            InlineKeyboardButton(text="2:3", callback_data="aspect_2:3"),
        ],
    ])

# –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ –¥–ª—è –≤–∏–¥–µ–æ
def video_aspect_ratio_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="16:9 (—à–∏—Ä–æ–∫–∏–π)", callback_data="video_aspect_16:9"),
            InlineKeyboardButton(text="9:16 (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π)", callback_data="video_aspect_9:16"),
        ],
        [InlineKeyboardButton(text="1:1 (–∫–≤–∞–¥—Ä–∞—Ç)", callback_data="video_aspect_1:1")],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ
def video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="duration_5"),
            InlineKeyboardButton(text="7 —Å–µ–∫", callback_data="duration_7"),
        ],
        [
            InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="duration_10"),
            InlineKeyboardButton(text="12 —Å–µ–∫", callback_data="duration_12"),
            InlineKeyboardButton(text="15 —Å–µ–∫", callback_data="duration_15"),
        ],
    ])

# –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
def batch_count_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="2 —à—Ç", callback_data="batch_2"),
            InlineKeyboardButton(text="4 —à—Ç", callback_data="batch_4"),
        ],
        [
            InlineKeyboardButton(text="6 —à—Ç", callback_data="batch_6"),
            InlineKeyboardButton(text="8 —à—Ç", callback_data="batch_8"),
        ],
    ])

# –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ
def image_to_video_duration_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="3 —Å–µ–∫", callback_data="i2v_duration_3"),
            InlineKeyboardButton(text="5 —Å–µ–∫", callback_data="i2v_duration_5"),
        ],
        [InlineKeyboardButton(text="10 —Å–µ–∫", callback_data="i2v_duration_10")],
    ])

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
def batch_edit_ready_keyboard(count: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"‚úÖ –ì–æ—Ç–æ–≤–æ ({count} —Ñ–æ—Ç–æ)", callback_data="batch_edit_ready")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="batch_edit_cancel")],
    ])

# –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ –∏–ª–∏ –≥–æ—Ç–æ–≤–æ
def batch_edit_add_more_keyboard(count: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìé –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë", callback_data="batch_edit_add")],
        [InlineKeyboardButton(text=f"‚úÖ –ì–æ—Ç–æ–≤–æ ({count})", callback_data="batch_edit_ready")],
    ])

# –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç
def skip_prompt_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="skip_prompt")]
    ])
2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π states.py
Python
Copy
from aiogram.fsm.state import State, StatesGroup

class ImageGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class BatchGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_count = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class ImageEditState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class BatchEditState(StatesGroup):
    collecting_images = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    generating = State()

class VideoGenState(StatesGroup):
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()

class ImageToVideoState(StatesGroup):
    waiting_for_image = State()
    waiting_for_prompt = State()
    waiting_for_aspect_ratio = State()
    waiting_for_duration = State()
    generating = State()
3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π image_to_video.py (–∏–º–ø–æ—Ä—Ç skip_prompt_keyboard –∏–∑ keyboards)
Python
Copy
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, PhotoSize
from aiogram.fsm.context import FSMContext

from bot.services.kling_service import kling_service
from bot.services.user_settings import settings_manager
from bot.services.file_storage import file_storage
from bot.keyboards import (
    video_aspect_ratio_keyboard, 
    image_to_video_duration_keyboard, 
    main_menu,
    skip_prompt_keyboard  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –∏–º–ø–æ—Ä—Ç –∏–∑ keyboards
)
from bot.states import ImageToVideoState

router = Router()
logger = logging.getLogger(__name__)


@router.message(F.text == "üñºÔ∏è –§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ")
async def start_image_to_video(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ñ–æ—Ç–æ-–≤-–≤–∏–¥–µ–æ"""
    quality = settings_manager.get_video_quality(message.from_user.id)
    quality_name = "‚ö° Standard" if quality == "std" else "üé¨ Pro"
    
    await message.answer(
        f"üñºÔ∏è <b>–§–æ—Ç–æ –≤ –≤–∏–¥–µ–æ</b>\n"
        f"–ö–∞—á–µ—Å—Ç–≤–æ: {quality_name}\n\n"
        f"üìé <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</b>\n"
        f"–ò–∑ –Ω–µ—ë —Å–æ–∑–¥–∞–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ",
        parse_mode="HTML"
    )
    await state.set_state(ImageToVideoState.waiting_for_image)


@router.message(ImageToVideoState.waiting_for_image, F.photo)
async def receive_i2v_photo(message: Message, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    photo = message.photo[-1]
    await process_i2v_image(message, bot, photo.file_id, state)


@router.message(ImageToVideoState.waiting_for_image, F.document)
async def receive_i2v_document(message: Message, state: FSMContext, bot: Bot):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        return
    await process_i2v_image(message, bot, doc.file_id, state)


async def process_i2v_image(message: Message, bot: Bot, file_id: str, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ...")
    
    try:
        photo_url = await file_storage.save_image_from_telegram(
            bot=bot,
            file_id=file_id,
            user_id=message.from_user.id
        )
        
        if not photo_url:
            await message.answer("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ.")
            return
        
        await state.update_data(photo_url=photo_url)
        
        await message.answer(
            "‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n\n"
            "‚úèÔ∏è <b>–û–ø–∏—à–∏—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ</b> (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞¬ª –∏–ª–∏ ¬´–ß–µ–ª–æ–≤–µ–∫ —É–ª—ã–±–∞–µ—Ç—Å—è¬ª\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏:",
            parse_mode="HTML",
            reply_markup=skip_prompt_keyboard()
        )
        await state.set_state(ImageToVideoState.waiting_for_prompt)
        
    except Exception as e:
        logger.exception(f"Failed to process image: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.")


@router.message(ImageToVideoState.waiting_for_prompt)
async def receive_i2v_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ"""
    prompt = message.text.strip()
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ {prompt}\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_aspect_ratio)


@router.callback_query(ImageToVideoState.waiting_for_prompt, F.data == "skip_prompt")
async def skip_i2v_prompt(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç"""
    await state.update_data(prompt="Animate this image naturally with subtle motion")
    
    await callback.message.edit_text(
        "‚è≠Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ:</b>",
        parse_mode="HTML",
        reply_markup=video_aspect_ratio_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_aspect_ratio)


@router.callback_query(ImageToVideoState.waiting_for_aspect_ratio, F.data.startswith("video_aspect_"))
async def receive_i2v_aspect(callback: CallbackQuery, state: FSMContext):
    aspect_ratio = callback.data.replace("video_aspect_", "")
    await state.update_data(aspect_ratio=aspect_ratio)
    
    await callback.message.edit_text(
        f"üìê {aspect_ratio}\n\n"
        f"‚è± <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b>",
        parse_mode="HTML",
        reply_markup=image_to_video_duration_keyboard()
    )
    await state.set_state(ImageToVideoState.waiting_for_duration)


@router.callback_query(ImageToVideoState.waiting_for_duration, F.data.startswith("i2v_duration_"))
async def generate_image_to_video(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ"""
    duration = int(callback.data.replace("i2v_duration_", ""))
    data = await state.get_data()
    prompt = data.get("prompt", "Animate naturally")
    aspect_ratio = data["aspect_ratio"]
    photo_url = data["photo_url"]
    user_id = callback.from_user.id
    
    quality = settings_manager.get_video_quality(user_id)
    
    await callback.message.edit_text(
        f"‚è≥ –°–æ–∑–¥–∞—é –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ...\n"
        f"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} —Å–µ–∫\n"
        f"‚è± –û–∂–∏–¥–∞–Ω–∏–µ: 2-5 –º–∏–Ω—É—Ç"
    )
    await state.set_state(ImageToVideoState.generating)
    
    try:
        if quality == "pro":
            result = await kling_service.generate_video_omni_pro(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio,
                start_image_url=photo_url
            )
        else:
            result = await kling_service.generate_video_omni_std(
                prompt=prompt,
                duration=duration,
                aspect_ratio=aspect_ratio,
                start_image_url=photo_url
            )
        
        if result and result.get("task_id"):
            task_id = result["task_id"]
            
            await callback.message.edit_text(
                f"üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞—Ç–∞...\n"
                f"ID –∑–∞–¥–∞—á–∏: {task_id}\n"
                f"–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å..."
            )
            
            status = await kling_service.wait_for_completion(task_id, max_attempts=60, delay=5)
            
            if status and status.get("data", {}).get("status") == "COMPLETED":
                video_url = status["data"]["result"]["video_url"]
                
                await callback.message.delete()
                await bot.send_video(
                    chat_id=user_id,
                    video=video_url,
                    caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!\nüìù {prompt}\nüìê {aspect_ratio} | ‚è± {duration}—Å–µ–∫",
                    reply_markup=main_menu()
                )
            else:
                error_msg = status.get("data", {}).get("error", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞") if status else "–¢–∞–π–º–∞—É—Ç"
                await callback.message.edit_text(
                    f"‚ùå –í–∏–¥–µ–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ.\n–û—à–∏–±–∫–∞: {error_msg}",
                    reply_markup=main_menu()
                )
        else:
            error = result.get("error") if result else "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API"
            await callback.message.edit_text(
                f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞.\n{error}",
                reply_markup=main_menu()
            )
            
    except Exception as e:
        logger.exception(f"I2V generation failed: {e}")
        await callback.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=main_menu()
        )
    
    await state.clear()
4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π batch_editing.py (–¥–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç InlineKeyboardMarkup)
Python
Copy
import logging
import asyncio
from typing import List
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery, BufferedInputFile, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext

from bot.services.gemini_service import gemini_service
from bot.services.user_settings import settings_manager
from bot.keyboards import (
    aspect_ratio_keyboard, 
    main_menu, 
    batch_edit_ready_keyboard,
    batch_edit_add_more_keyboard
)
from bot.states import BatchEditState

router = Router()
logger = logging.getLogger(__name__)

MAX_BATCH_EDIT_IMAGES = 10


@router.message(F.text == "üìÇ –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
async def start_batch_editing(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    await state.update_data(images=[], image_count=0)
    
    await message.answer(
        "üìÇ <b>–ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n\n"
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</b>, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ.\n\n"
        "üìé <b>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É</b> –∏–ª–∏ –≥—Ä—É–ø–ø–æ–π\n"
        f"–ú–∞–∫—Å–∏–º—É–º: {MAX_BATCH_EDIT_IMAGES} —à—Ç\n\n"
        "–ö–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Å–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª",
        parse_mode="HTML",
        reply_markup=batch_edit_ready_keyboard(0)
    )
    await state.set_state(BatchEditState.collecting_images)


@router.message(BatchEditState.collecting_images, F.photo)
async def receive_batch_photo(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ"""
    data = await state.get_data()
    images: List[bytes] = data.get("images", [])
    count = data.get("image_count", 0)
    
    if count >= MAX_BATCH_EDIT_IMAGES:
        await message.answer(
            f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç ({MAX_BATCH_EDIT_IMAGES} —Ñ–æ—Ç–æ)\n"
            f"–ù–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è",
            reply_markup=batch_edit_ready_keyboard(count)
        )
        return
    
    try:
        photo = message.photo[-1]
        file = await message.bot.get_file(photo.file_id)
        image_bytes = await message.bot.download_file(file.file_path)
        image_data = image_bytes.read()
        
        images.append(image_data)
        count += 1
        
        await state.update_data(images=images, image_count=count)
        
        await message.answer(
            f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {count} —Ñ–æ—Ç–æ\n"
            f"üìé –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –∏–ª–∏ –Ω–∞–∂–∞—Ç—å ¬´–ì–æ—Ç–æ–≤–æ¬ª",
            reply_markup=batch_edit_add_more_keyboard(count)
        )
        
    except Exception as e:
        logger.exception(f"Failed to download photo: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ")


@router.message(BatchEditState.collecting_images, F.document)
async def receive_batch_document(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª"""
    doc = message.document
    
    if not doc.mime_type or not doc.mime_type.startswith("image/"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        return
    
    data = await state.get_data()
    images: List[bytes] = data.get("images", [])
    count = data.get("image_count", 0)
    
    if count >= MAX_BATCH_EDIT_IMAGES:
        await message.answer(
            f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç ({MAX_BATCH_EDIT_IMAGES} —Ñ–æ—Ç–æ)",
            reply_markup=batch_edit_ready_keyboard(count)
        )
        return
    
    try:
        file = await message.bot.get_file(doc.file_id)
        image_bytes = await message.bot.download_file(file.file_path)
        image_data = image_bytes.read()
        
        images.append(image_data)
        count += 1
        
        await state.update_data(images=images, image_count=count)
        
        await message.answer(
            f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {count} —Ñ–æ—Ç–æ",
            reply_markup=batch_edit_add_more_keyboard(count)
        )
        
    except Exception as e:
        logger.exception(f"Failed to download document: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞")


@router.callback_query(BatchEditState.collecting_images, F.data == "batch_edit_add")
async def continue_adding(callback: CallbackQuery):
    """–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å"""
    await callback.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ")


@router.callback_query(BatchEditState.collecting_images, F.data == "batch_edit_ready")
async def finish_collecting(callback: CallbackQuery, state: FSMContext):
    """–ó–∞–∫–æ–Ω—á–∏–ª–∏ —Å–æ–±–∏—Ä–∞—Ç—å —Ñ–æ—Ç–æ"""
    data = await state.get_data()
    images = data.get("images", [])
    count = data.get("image_count", 0)
    
    if count == 0:
        await callback.answer("‚ùå –ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ!")
        return
    
    if count == 1:
        await callback.message.edit_text(
            "‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ 1 —Ñ–æ—Ç–æ.\n"
            "–î–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ¬ª\n\n"
            "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ –∏–ª–∏ –æ—Ç–º–µ–Ω–∞?",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data="batch_continue_anyway")],
                [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="batch_edit_cancel")],
            ])
        )
        return
    
    await proceed_to_prompt(callback, state)


@router.callback_query(BatchEditState.collecting_images, F.data == "batch_continue_anyway")
async def continue_single(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ —Å 1 —Ñ–æ—Ç–æ"""
    await proceed_to_prompt(callback, state)


async def proceed_to_prompt(callback: CallbackQuery, state: FSMContext):
    """–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –ø—Ä–æ–º–ø—Ç–∞"""
    data = await state.get_data()
    count = data.get("image_count", 0)
    
    await callback.message.edit_text(
        f"‚úÖ <b>{count} —Ñ–æ—Ç–æ</b> –ø—Ä–∏–Ω—è—Ç–æ!\n\n"
        f"‚úèÔ∏è <b>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å–æ –≤—Å–µ–º–∏ —Ñ–æ—Ç–æ?</b>\n"
        f"–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        f"‚Ä¢ ¬´–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç¬ª\n"
        f"‚Ä¢ ¬´–°–¥–µ–ª–∞—Ç—å —á—ë—Ä–Ω–æ-–±–µ–ª—ã–º¬ª\n"
        f"‚Ä¢ ¬´–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–º–∫—É¬ª\n"
        f"‚Ä¢ ¬´–£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ¬ª",
        parse_mode="HTML"
    )
    await state.set_state(BatchEditState.waiting_for_prompt)


@router.message(BatchEditState.waiting_for_prompt)
async def receive_batch_prompt(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ"""
    prompt = message.text.strip()
    
    if len(prompt) < 3:
        await message.answer("‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:")
        return
    
    await state.update_data(prompt=prompt)
    
    await message.answer(
        f"‚úÖ –ó–∞–¥–∞—á–∞: <i>{prompt}</i>\n\n"
        f"üìê <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ:</b>",
        parse_mode="HTML",
        reply_markup=aspect_ratio_keyboard()
    )
    await state.set_state(BatchEditState.waiting_for_aspect_ratio)


@router.callback_query(BatchEditState.waiting_for_aspect_ratio, F.data.startswith("aspect_"))
async def execute_batch_edit(callback: CallbackQuery, state: FSMContext, bot: Bot):
    """–ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    aspect_ratio = callback.data.replace("aspect_", "")
    data = await state.get_data()
    prompt = data["prompt"]
    images: List[bytes] = data["images"]
    count = len(images)
    user_id = callback.from_user.id
    
    model_pref = settings_manager.get_image_model(user_id)
    model = "gemini-2.5-flash-image" if model_pref == "flash" else "gemini-3-pro-image-preview"
    
    await callback.message.edit_text(
        f"‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é {count} —Ñ–æ—Ç–æ...\n"
        f"–ó–∞–¥–∞—á–∞: {prompt}\n"
        f"0/{count} –≥–æ—Ç–æ–≤–æ"
    )
    await state.set_state(BatchEditState.generating)
    
    semaphore = asyncio.Semaphore(3)
    
    async def edit_single(index: int, image_data: bytes) -> tuple:
        async with semaphore:
            try:
                result = await gemini_service.edit_image(
                    image_bytes=image_data,
                    instruction=prompt,
                    model=model,
                    aspect_ratio=aspect_ratio
                )
                return (index, result, None)
            except Exception as e:
                logger.exception(f"Failed to edit image {index}: {e}")
                return (index, None, str(e))
    
    tasks = [edit_single(i, img) for i, img in enumerate(images)]
    results = await asyncio.gather(*tasks)
    
    results.sort(key=lambda x: x[0])
    
    successful = 0
    failed = 0
    
    await callback.message.delete()
    
    status_msg = await bot.send_message(
        user_id,
        f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
    )
    
    for index, result, error in results:
        if result:
            successful += 1
            await bot.send_photo(
                chat_id=user_id,
                photo=BufferedInputFile(result, filename=f"edited_{index+1}.png"),
                caption=f"‚úÖ #{index+1}"
            )
        else:
            failed += 1
            await bot.send_message(
                user_id,
                f"‚ùå #{index+1} ‚Äî –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"
            )
    
    await status_msg.delete()
    await bot.send_message(
        user_id,
        f"‚úÖ <b>–ì–æ—Ç–æ–≤–æ!</b>\n\n"
        f"üìù –ó–∞–¥–∞—á–∞: {prompt}\n"
        f"üìê –§–æ—Ä–º–∞—Ç: {aspect_ratio}\n"
        f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {successful}/{count}\n"
        f"‚ùå –û—à–∏–±–æ–∫: {failed}",
        parse_mode="HTML",
        reply_markup=main_menu()
    )
    
    await state.clear()


@router.callback_query(F.data == "batch_edit_cancel")
async def cancel_batch_edit(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞"""
    await callback.message.edit_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ")
    await callback.message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu())
    await state.clear()
5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π bot.py (–¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã)
Python
Copy
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage

from bot.config import config
from bot.handlers import (
    start, 
    settings, 
    image_generation, 
    image_editing, 
    video_generation,
    batch_generation,
    batch_editing,
    image_to_video
)
from bot.services.file_storage import file_storage

logging.basicConfig(level=logging.INFO)

async def cleanup_task():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"""
    while True:
        await asyncio.sleep(3600)
        try:
            deleted = file_storage.cleanup_old_files(max_age_hours=24)
            logging.info(f"Cleanup completed: {deleted} files deleted")
        except Exception as e:
            logging.error(f"Cleanup error: {e}")

async def main():
    bot = Bot(token=config.BOT_TOKEN, parse_mode=ParseMode.HTML)
    dp = Dispatcher(storage=MemoryStorage())
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(start.router)
    dp.include_router(settings.router)
    dp.include_router(image_generation.router)
    dp.include_router(batch_generation.router)
    dp.include_router(image_editing.router)
    dp.include_router(batch_editing.router)
    dp.include_router(video_generation.router)
    dp.include_router(image_to_video.router)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É –≤ —Ñ–æ–Ω–µ
    asyncio.create_task(cleanup_task())
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
